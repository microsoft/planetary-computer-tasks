
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Deploying PCTasks &#8212; Planetary Computer Tasks  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="reference.html" />
    <link rel="prev" title="Developing" href="developing.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    <p class="title logo__title">Planetary Computer Tasks</p>
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="developing.html">
  Developing
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="current reference internal nav-link" href="#">
  Deploying PCTasks
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="reference.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="runtime.html">
  Runtime Environment
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <span id="theme-switch" class="btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
    
    <div class="toc-item">
      
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Deploying PCTasks
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#required-resources">
   Required resources
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deployment-service-principal">
     Deployment Service principal
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pgstac-database">
     PgSTAC Database
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploy-secrets-keyvault">
     Deploy secrets KeyVault
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#terraform-variables">
     Terraform Variables
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#roles">
     Roles
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#terraform-structure">
   Terraform structure
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-deploy">
   Running deploy
  </a>
 </li>
</ul>

</nav>
    </div>
    
    <div class="toc-item">
      
    </div>
    
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <section id="deploying-pctasks">
<h1>Deploying PCTasks<a class="headerlink" href="#deploying-pctasks" title="Permalink to this heading">#</a></h1>
<p>PCTasks deploys using Terraform for infrastructure, Helm for managing helm charts in the AKS cluster, and Azure Function Core Tools for
deploying Azure Functions. The steps to deploy are encapsulated in the <code class="docutils literal notranslate"><span class="pre">deployment/bin/deploy</span></code> script. All deployment operations take
place in the <code class="docutils literal notranslate"><span class="pre">deploy</span></code> service container run through <code class="docutils literal notranslate"><span class="pre">scripts/console</span> <span class="pre">--deploy</span></code>, which runs a console in the deploy service container managed
by <code class="docutils literal notranslate"><span class="pre">deploy/docker-compose.yaml</span></code>.</p>
</section>
<section id="required-resources">
<h1>Required resources<a class="headerlink" href="#required-resources" title="Permalink to this heading">#</a></h1>
<p>There are resources that PCTasks depends on that are not deployed itself, and need to be managed out-of-band. This can be done by creating
the resources manually through the Azure Portal or through separate terraform processes.</p>
<section id="deployment-service-principal">
<h2>Deployment Service principal<a class="headerlink" href="#deployment-service-principal" title="Permalink to this heading">#</a></h2>
<p>You’ll need a service principal that has sufficient permissions to deploy Azure resources, including creating resource groups and assigning IAM roles.</p>
<p>The service principal information fed to the deployment container through the following environment vars on the host:</p>
<ul class="simple">
<li><p>AZURE_SUBSCRIPTION_ID</p></li>
<li><p>AZURE_TENANT_ID</p></li>
<li><p>AZURE_CLIENT_ID</p></li>
<li><p>AZURE_CLIENT_SECRET</p></li>
</ul>
</section>
<section id="pgstac-database">
<h2>PgSTAC Database<a class="headerlink" href="#pgstac-database" title="Permalink to this heading">#</a></h2>
<p>The PgSTAC database information is written into the PCTasks key vault as a secret that is available to workflows through <code class="docutils literal notranslate"><span class="pre">${{</span> <span class="pre">secrets.pgstac-connection-string</span> <span class="pre">}}</span></code>.</p>
</section>
<section id="deploy-secrets-keyvault">
<h2>Deploy secrets KeyVault<a class="headerlink" href="#deploy-secrets-keyvault" title="Permalink to this heading">#</a></h2>
<p>The deploy secrets keyvault holds keys for terraform to read. The keyvault must contain a secret that holds the terraform values file that is used to specify values for terraform variables, described below.</p>
</section>
<section id="terraform-variables">
<h2>Terraform Variables<a class="headerlink" href="#terraform-variables" title="Permalink to this heading">#</a></h2>
<p>A terraform variables file is stored in the deployment keyvault, which is fetched and applied to the deployment of a specific stack in the terraform stage. The keyvault secret that is fetched depends on the <code class="docutils literal notranslate"><span class="pre">env.sh</span></code> file stored in the stack’s terraform directory. For example,
in deployment/terraform/staging, the env.sh reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="n">export</span> <span class="n">DEPLOY_SECRETS_KV</span><span class="o">=</span><span class="n">pc</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="n">secrets</span>
<span class="n">export</span> <span class="n">DEPLOY_SECRETS_KV_SECRET</span><span class="o">=</span><span class="n">pctasks</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">tfvars</span><span class="o">-</span><span class="n">staging</span>
</pre></div>
</div>
<p>This means that the tfvars file to apply to this terraform deploy is in the deploy secrets keyvault named <code class="docutils literal notranslate"><span class="pre">pc-test-deploy-secrets</span></code> under the secret name <code class="docutils literal notranslate"><span class="pre">pctasks-test-tfvars-staging</span></code>.</p>
<p>When creating a new tfvars, use the <code class="docutils literal notranslate"><span class="pre">values.tfvars.template</span></code> in teh <code class="docutils literal notranslate"><span class="pre">deployment/terraform/resources</span></code> directory and fill out all the information. Then you must use the Azure CLI to write the tfvars into keyvault - writing through the portal will strip newlines and will not work.  You can use the <code class="docutils literal notranslate"><span class="pre">deployment/bin/write_tfvars</span></code> script to write a tfvars file to a keyvault secret.</p>
<p>The tfvars template file has documentation on each of the variables that need to be supplied.</p>
<p>Also, you can use the <code class="docutils literal notranslate"><span class="pre">--skip-fetch-tf-vars</span></code> option to <code class="docutils literal notranslate"><span class="pre">bin/deploy</span></code> to skip fetching the terraform values from keyvault, which requires that the <code class="docutils literal notranslate"><span class="pre">values.tfvars</span></code> file be at the proper location in the stack terraform directory.</p>
</section>
<section id="roles">
<h2>Roles<a class="headerlink" href="#roles" title="Permalink to this heading">#</a></h2>
<p>The service principal specified by the <code class="docutils literal notranslate"><span class="pre">task_acr_sp_object_id</span></code> variable must have <code class="docutils literal notranslate"><span class="pre">AcrPull</span></code> permissions on the ACR specified by the <code class="docutils literal notranslate"><span class="pre">task_acr_name</span></code> variable.</p>
</section>
</section>
<section id="terraform-structure">
<h1>Terraform structure<a class="headerlink" href="#terraform-structure" title="Permalink to this heading">#</a></h1>
<p>The terraform is divided into a <code class="docutils literal notranslate"><span class="pre">resources</span></code> folder, which holds all the definitions of resources that are used across environments, and a set of environment stacks like <code class="docutils literal notranslate"><span class="pre">dev</span></code> and <code class="docutils literal notranslate"><span class="pre">staging</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">dev</span></code> stack is used to bring up an entire stack of pctasks for personal development. The terraform backend used is local to the users machine. The stack resources will be named according to the <code class="docutils literal notranslate"><span class="pre">$USER</span></code> environment variable.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">staging</span></code> stack is deployed via CI/CD to the sandboxed Planetary Computer Test subscription. Only CI/CD and administrators should run deployment against this stack.</p>
</section>
<section id="running-deploy">
<h1>Running deploy<a class="headerlink" href="#running-deploy" title="Permalink to this heading">#</a></h1>
<p>To run deploy, ensure your deployment service principal environment variables are set and drop into a deployment console with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">scripts</span><span class="o">/</span><span class="n">console</span> <span class="o">--</span><span class="n">deploy</span>
</pre></div>
</div>
<p>Then run the deploy script for your stack, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="nb">bin</span><span class="o">/</span><span class="n">deploy</span> <span class="o">-</span><span class="n">t</span> <span class="n">terraform</span><span class="o">/</span><span class="n">dev</span>
</pre></div>
</div>
</section>


              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="developing.html" title="previous page">
      <i class="fas fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Developing</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="reference.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">API Reference</p>
  </div>
  <i class="fas fa-angle-right"></i>
  </a>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, Microsoft.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.0.2.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>